!function(){"use strict";const t="single-file-request-fetch-supported",n="single-file-response-fetch-supported",e="single-file-request-fetch",r="single-file-response-fetch",a="Host fetch error (SingleFile)",c=Boolean(window.wrappedJSObject),i=(t,n)=>(n.cache="force-cache",n.referrerPolicy="strict-origin-when-cross-origin",window.fetch(t,n));let s,o=0,u=new Map;async function f(f,w={}){try{const o={cache:"force-cache",headers:w.headers,referrerPolicy:"strict-origin-when-cross-origin"};let u;try{u=w.referrer&&!c?await i(f,o):await async function(c,o){if(void 0===s&&(s=!1,document.addEventListener(n,(()=>s=!0),!1),document.dispatchEvent(new CustomEvent(t))),!s)return i(c,o);{const t=new Promise(((t,n)=>{document.dispatchEvent(new CustomEvent(e,{detail:JSON.stringify({url:c,options:o})})),document.addEventListener(r,(function e(a){a.detail?a.detail.url==c&&(document.removeEventListener(r,e,!1),a.detail.response?t({status:a.detail.status,headers:new Map(a.detail.headers),arrayBuffer:async()=>a.detail.response}):n(a.detail.error)):n()}),!1)}));try{return await t}catch(t){if(t&&t.message==a)return i(c,o);throw t}}}(f,o)}catch(t){if(!t||t.message!=a)throw t;u=await i(f,o)}return u}catch(t){o++;const n=new Promise(((t,n)=>u.set(o,{resolve:t,reject:n})));return await y({method:"singlefile.fetch",url:f,requestId:o,referrer:w.referrer,headers:w.headers}),n}}async function w(t,n){const e=await y({method:"singlefile.fetchFrame",url:t,frameId:n.frameId,referrer:n.referrer,headers:n.headers});return{status:e.status,headers:new Map(e.headers),arrayBuffer:async()=>new Uint8Array(e.array).buffer}}async function y(t){const n=await browser.runtime.sendMessage(t);if(!n||n.error)throw new Error(n&&n.error&&n.error.toString());return n}browser.runtime.onMessage.addListener((t=>"singlefile.fetchFrame"==t.method&&window.frameId&&window.frameId==t.frameId?async function(t){try{const n=await i(t.url,{cache:"force-cache",headers:t.headers,referrerPolicy:"strict-origin-when-cross-origin"});return{status:n.status,headers:[...n.headers],array:Array.from(new Uint8Array(await n.arrayBuffer()))}}catch(t){return{error:t&&t.toString()}}}(t):"singlefile.fetchResponse"==t.method?async function(t){const n=u.get(t.requestId);n&&(t.error?(n.reject(new Error(t.error)),u.delete(t.requestId)):(t.truncated&&(n.array?n.array=n.array.concat(t.array):(n.array=t.array,u.set(t.requestId,n)),t.finished&&(t.array=n.array)),t.truncated&&!t.finished||(n.resolve({status:t.status,headers:{get:n=>t.headers&&t.headers[n]},arrayBuffer:async()=>new Uint8Array(t.array).buffer}),u.delete(t.requestId))));return{}}(t):void 0));const l=0,d=[l],h=Symbol(),m=new TextEncoder,b=new TextDecoder,g=new Array(256);let p=0;function A(t,n,e,r){if(void 0===r){if(p++,!(g.length-p>=d.length))throw new Error("Reached maximum number of custom types");g[g.length-p]={serialize:t,parse:n,test:e}}else g[r]={serialize:t,parse:n,test:e}}async function U(t){const n=function(){let t,n,e,r,a,c;return{next:async t=>t?i(t):{value:await r,done:!0},return:()=>({done:!0})};async function i(t){return a?await a:s().catch((()=>{})),u(),e(t),{done:!1}}async function s(){let n;r=new Promise((t=>n=t)),t=new x(f),o();const e=await S(t);t.executeSetters(),n(e)}function o(){n=new Promise((t=>e=t))}function u(){a=new Promise((t=>c=t))}async function f(){const t=await n;return o(),c&&c(),t}}();await n.next(t);return(await n.next()).value}async function v(t,n){const e=g.findIndex((({test:e}={})=>e&&e(n,t)));t.addObject(n),await t.append(new Uint8Array([e]));const r=g[e].serialize;r&&await r(t,n),e!=l&&M(n)&&(await async function(t,n){const e=Object.getOwnPropertySymbols(n),r=e.map((t=>[t,n[t]]));await j(t,r)}(t,n),await async function(t,n){if(ArrayBuffer.isView(n))await v(t,0);else{let e=Object.entries(n);T(n)&&(e=e.filter((([t])=>!z(Number(t))))),await v(t,e.length);for(const[n,r]of e)await O(t,n),await v(t,r)}}(t,n))}async function j(t,n){await v(t,n.length);const e=Object.keys(n).filter((t=>z(Number(t)))).map((t=>Number(t)));let r=0,a=e[r];for(const[c,i]of n.entries())a==c?(a=e[++r],await v(t,i)):await v(t,h)}async function O(t,n){const e=m.encode(n);await v(t,e.length),await t.append(e)}async function I(t,n){await v(t,n.length),await t.append("Uint8Array"==n.constructor.name?n:new Uint8Array(n.buffer))}async function E(t,n){const e=new Uint8Array(new Float64Array([n]).buffer);await t.append(e)}async function L(t,n){const e=new Uint8Array([Number(n)]);await t.append(e)}A((async function(t,n){const e=t.objects.indexOf(n);await v(t,e)}),(async function(t){const n=await S(t);return new R(n,t)}),(function(t,n){return M(t)&&n.objects.includes(t)}),l),A(null,(function(){return{}}),M),A(j,N,T),A(O,P,(function(t){return"string"==typeof t})),A(I,(async function(t){const n=await S(t),e=await t.consume(8*n);return new Float64Array(e.buffer)}),(function(t){return"Float64Array"==t.constructor.name})),A(I,(async function(t){const n=await S(t),e=await t.consume(4*n);return new Float32Array(e.buffer)}),(function(t){return"Float32Array"==t.constructor.name})),A(I,(async function(t){const n=await S(t),e=await t.consume(4*n);return new Uint32Array(e.buffer)}),(function(t){return"Uint32Array"==t.constructor.name})),A(I,(async function(t){const n=await S(t),e=await t.consume(4*n);return new Int32Array(e.buffer)}),(function(t){return"Int32Array"==t.constructor.name})),A(I,(async function(t){const n=await S(t),e=await t.consume(2*n);return new Uint16Array(e.buffer)}),(function(t){return"Uint16Array"==t.constructor.name})),A(I,(async function(t){const n=await S(t),e=await t.consume(2*n);return new Int16Array(e.buffer)}),(function(t){return"Int16Array"==t.constructor.name})),A(I,(async function(t){const n=await S(t),e=await t.consume(n);return new Uint8ClampedArray(e.buffer)}),(function(t){return"Uint8ClampedArray"==t.constructor.name})),A(I,(async function(t){const n=await S(t);return await t.consume(n)}),(function(t){return"Uint8Array"==t.constructor.name})),A(I,(async function(t){const n=await S(t),e=await t.consume(n);return new Int8Array(e.buffer)}),(function(t){return"Int8Array"==t.constructor.name})),A((async function(t,n){await v(t,n.byteLength),await t.append(new Uint8Array(n))}),(async function(t){const n=await S(t);return(await t.consume(n)).buffer}),(function(t){return"ArrayBuffer"==t.constructor.name})),A(E,F,k),A((async function(t,n){const e=new Uint8Array(new Uint32Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(4);return new Uint32Array(n.buffer)[0]}),(function(t){return z(t)&&t>=0&&t<=4294967295})),A((async function(t,n){const e=new Uint8Array(new Int32Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(4);return new Int32Array(n.buffer)[0]}),(function(t){return z(t)&&t>=-2147483648&&t<=2147483647})),A((async function(t,n){const e=new Uint8Array(new Uint16Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(2);return new Uint16Array(n.buffer)[0]}),(function(t){return z(t)&&t>=0&&t<=65535})),A((async function(t,n){const e=new Uint8Array(new Int16Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(2);return new Int16Array(n.buffer)[0]}),(function(t){return z(t)&&t>=-32768&&t<=32767})),A((async function(t,n){const e=new Uint8Array([n]);await t.append(e)}),(async function(t){const n=await t.consume(1);return new Uint8Array(n.buffer)[0]}),(function(t){return z(t)&&t>=0&&t<=255})),A((async function(t,n){const e=new Uint8Array(new Int8Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(1);return new Int8Array(n.buffer)[0]}),(function(t){return z(t)&&t>=-128&&t<=127})),A(null,(function(){return}),(function(t){return void 0===t})),A(null,(function(){return null}),(function(t){return null===t})),A(null,(function(){return NaN}),(function(t){return Number.isNaN(t)})),A(L,q,(function(t){return"boolean"==typeof t})),A((async function(t,n){await O(t,n.description)}),(async function(t){const n=await P(t);return Symbol(n)}),H),A(null,(function(){return h}),C),A((async function(t,n){const e=n.entries();await v(t,n.size);for(const[n,r]of e)await v(t,n),await v(t,r)}),(async function(t){const n=await S(t),e=new Map;n&&await async function r(a=0){const c=await S(t),i=await S(t);t.setObject([c,i],((t,n)=>e.set(t,n))),a<n-1&&await r(a+1)}();return e}),(function(t){return t instanceof Map})),A((async function(t,n){await v(t,n.size);for(const e of n)await v(t,e)}),(async function(t){const n=await S(t),e=new Set;n&&await async function r(a=0){const c=await S(t);t.setObject([c],(t=>e.add(t))),a<n-1&&await r(a+1)}();return e}),(function(t){return t instanceof Set})),A((async function(t,n){await E(t,n.getTime())}),(async function(t){const n=await F(t);return new Date(n)}),(function(t){return t instanceof Date})),A((async function(t,n){await O(t,n.message),await O(t,n.stack)}),(async function(t){const n=await P(t),e=await P(t),r=new Error(n);return r.stack=e,r}),(function(t){return t instanceof Error})),A((async function(t,n){await O(t,n.source),await O(t,n.flags)}),(async function(t){const n=await P(t),e=await P(t);return new RegExp(n,e)}),(function(t){return t instanceof RegExp})),A((async function(t,n){await O(t,n.valueOf())}),(async function(t){return new String(await P(t))}),(function(t){return t instanceof String})),A((async function(t,n){await E(t,n.valueOf())}),(async function(t){return new Number(await F(t))}),(function(t){return t instanceof Number})),A((async function(t,n){await L(t,n.valueOf())}),(async function(t){return new Boolean(await q(t))}),(function(t){return t instanceof Boolean}));class R{constructor(t,n){this.index=t,this.data=n}getObject(){return this.data.objects[this.index]}}class x{constructor(t){this.stream=new B(t),this.objects=[],this.setters=[]}consume(t){return this.stream.consume(t)}getObjectId(){const t=this.objects.length;return this.objects.push(void 0),t}resolveObject(t,n){(function(t){return M(t)||H(t)})(n)&&!D(n)&&(this.objects[t]=n)}setObject(t,n){this.setters.push({functionArguments:t,setterFunction:n})}executeSetters(){this.setters.forEach((({functionArguments:t,setterFunction:n})=>{n(...t.map((t=>D(t)?t.getObject():t)))}))}}class B{constructor(t){this.offset=0,this.value=new Uint8Array(0),this.consumeData=t}async consume(t){if(this.offset+t>this.value.length){const n=this.value.subarray(this.offset,this.value.length),e=await this.consumeData();return n.length+e.length!=this.value.length&&(this.value=new Uint8Array(n.length+e.length)),this.value.set(n),this.value.set(e,n.length),this.offset=0,this.consume(t)}{const n=this.value.slice(this.offset,this.offset+t);return this.offset+=n.length,n}}}async function S(t){const n=(await t.consume(1))[0],e=g[n].parse,r=t.getObjectId(),a=await e(t);return n!=l&&M(a)&&(await async function(t,n){const e=await N(t);t.setObject([e],(t=>t.forEach((([t,e])=>n[t]=e))))}(t,a),await async function(t,n){const e=await S(t);e&&await r();async function r(a=0){const c=await P(t),i=await S(t);t.setObject([i],(t=>n[c]=t)),a<e-1&&await r(a+1)}}(t,a)),t.resolveObject(r,a),a}async function N(t){const n=await S(t),e=new Array(n);return n&&await async function r(a=0){const c=await S(t);C(c)||t.setObject([c],(t=>e[a]=t));a<n-1&&await r(a+1)}(),e}async function P(t){const n=await S(t),e=await t.consume(n);return b.decode(e)}async function F(t){const n=await t.consume(8);return new Float64Array(n.buffer)[0]}async function q(t){const n=await t.consume(1);return Boolean(n[0])}function D(t){return t instanceof R}function M(t){return t===Object(t)}function T(t){return"number"==typeof t.length}function C(t){return t===h}function k(t){return"number"==typeof t}function z(t){return k(t)&&Number.isInteger(t)}function H(t){return"symbol"==typeof t}function J(t,n={}){return new Promise(((e,r)=>{const a=new XMLHttpRequest;if(a.withCredentials=!0,a.responseType="arraybuffer",a.onerror=t=>r(new Error(t.detail)),a.onreadystatechange=()=>{a.readyState==XMLHttpRequest.DONE&&e({status:a.status,headers:{get:t=>a.getResponseHeader(t)},arrayBuffer:async()=>a.response})},a.open("GET",t,!0),n.headers)for(const t of Object.entries(n.headers))a.setRequestHeader(t[0],t[1]);a.send()}))}browser.runtime.onMessage.addListener((async({method:t,pageData:n,url:e,data:r,options:a,width:c,height:i})=>{if("processPage"==t){const t=await function(t,n,e,r={fetch:f,frameFetch:w}){return globalThis.singlefile.getPageData(t,r,n,e)}(a,null,null,{fetch:J}),e=new Blob(["string"==typeof t.content?t.content:new Uint8Array(t.content)],{type:n.mimeType});return{url:URL.createObjectURL(e),archiveTime:t.archiveTime,doctype:t.doctype,filename:t.filename,title:t.title}}if("compressPage"==t){const t=await function(t,n){return globalThis.singlefile.processors.compression.process(t,n)}(await U(n),a);return{url:URL.createObjectURL(t)}}if("getBlobURL"==t)return{url:URL.createObjectURL(new Blob([new Uint8Array(r)]))};if("revokeObjectURL"==t)return URL.revokeObjectURL(e),{};if("getImageData"==t){const t=new Image;await new Promise(((n,r)=>{t.onload=n,t.onerror=t=>r(new Error(t.detail)),t.src=e}));const n=document.createElement("canvas");n.width=c,n.height=i;const r=n.getContext("2d");r.drawImage(t,0,0,c,i);const{data:a}=await r.getImageData(0,0,c,i);return{url:URL.createObjectURL(new Blob([a]))}}}))}();
